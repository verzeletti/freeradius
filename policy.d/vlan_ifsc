#
# File: vlan_ifsc
#
# Função para determinar o VLAN Id do usuario ou computador, com base na árvore ldap (samba-ad)
#
# versao 20240201
#
# Glaidson Verzeletti <verzeletti@gmail.com>
#
#
# OBSERVAÇÕES:
#     OpenLDAP - Filtrar por Grupo "Domain User" com ID = 513
#                                  "LG-CTIC" ID = 43468 (não funciona ainda)
#                                       ou 10233?
#     Samba4 - Filtro por "Domain Users" não está funcionando
#
#
# EXEMPLOS DE FILTROS POR GRUPO:
#
#    if (LDAP-Group == "Domain Admins")
#
#    if (LDAP-Group == "LG-TAE" || LDAP-Group == "LG-DOCENTE" || LDAP-Group == "IFSC-ADM" || LDAP-Group == "WIFI-ADM")
#
#
# EXEMPLOS DE FILTROS POR DN:
#
#    if ("%{ldap:ldap:///OU=Usuarios,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}")
#
#    if ("%{ldap:ldap:///OU=Alunos,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}")
#
#
########################

rewrite.vlan_ifsc {
        # Logins proibidos de usar WIFI
        if (LDAP-Group == "LG-WIFI-Deny" || LDAP-Group == "WIFI-Deny") {
                reject
        }
        # Servidores, Tutores, Bolsistas
        elsif ("%{ldap:ldap:///OU=Usuarios,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}") {
                # Grupo com Permissão Especial
                if (LDAP-Group == "LG-CTIC") {
                        update reply {
                                Tunnel-Type := VLAN,
                                Tunnel-Medium-Type := IEEE-802,
                                Tunnel-Private-Group-Id += "120"
                        }
                        updated
                }
                # VLAN Administrativa Default
                else {
                        update reply {
                                Tunnel-Type := VLAN,
                                Tunnel-Medium-Type := IEEE-802,
                                Tunnel-Private-Group-Id += "520"
                        }
                        updated
                }
        }
        # Alunos
        elsif ("%{ldap:ldap:///OU=Alunos,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}") {
                update reply {
                        Tunnel-Type := VLAN,
                        Tunnel-Medium-Type := IEEE-802,
                        Tunnel-Private-Group-Id += "530"
                }
                updated
        }
        # Visitantes, Tercerizados e Computadores
        elsif ("%{ldap:ldap:///OU=Terceirizados,OU=Usuarios,OU=Lages_LAN,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}" || "%{ldap:ldap:///OU=Visitantes,OU=Usuarios,OU=Lages_LAN,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{User-Name}}" || "%{ldap:ldap:///OU=Wifi,OU=Visitantes,OU=Computadores,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{Stripped-User-Name}}") {
                update reply {
                        Tunnel-Type := VLAN,
                        Tunnel-Medium-Type := IEEE-802,
                        Tunnel-Private-Group-Id += "540"
                }
                updated
        }
        # Computadores Laboratorio e Terceirizados
        elsif ("%{ldap:ldap:///OU=Laboratorios,OU=Wifi,OU=Computadores,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{Stripped-User-Name}}" || "%{ldap:ldap:///OU=Terceirizados,OU=Wifi,OU=Computadores,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{Stripped-User-Name}}") {
                update reply {
                        Tunnel-Type := VLAN,
                        Tunnel-Medium-Type := IEEE-802,
                        Tunnel-Private-Group-Id += "300"
                }
                updated
        }
        # Computadores Administrativos
        elsif ("%{ldap:ldap:///OU=Administrativos,OU=Wifi,OU=Computadores,dc=lages,dc=sc?sAMAccountName?sub?sAMAccountName=%{Stripped-User-Name}}") {
                update reply {
                        Tunnel-Type := VLAN,
                        Tunnel-Medium-Type := IEEE-802,
                        Tunnel-Private-Group-Id += "200"
                }
                updated
        }
        else {
                update reply {
                        Tunnel-Type := VLAN,
                        Tunnel-Medium-Type := IEEE-802,
                        Tunnel-Private-Group-Id += "999"
                }
                updated
        }
}

                          
